language: generic

notifications:
  slack:
    on_success: change
    on_failure: always
    on_error: always
    on_cancel: always
    rooms:
      secure: "QKk/n9t+V28a/5Aab4mg+kQmVCVyY2VhjiCdowZXas90wQz8s55Mwj/Ekrcwvv8h6v2y+xBGWYes1EEiK7dnHOigPfRKp/9AiOq8CFajfqHnv9BOKXOfIr93GkCHWFoeuzZkOFVsOsyaIZI4nDeAlBfsSWknSrF22eWgW82qLTIiKZJdhR4LmnKaefdjFTwwoNwpwWGycUbRTJsk7CytBWUWnHVmODoU2p4mOz3gfYSmHWZt/Fa1KQNZupwnD5JpUZJqFileW9/josen8frhfpjwowYCFYbRo0KznP9AWbwUjkLYQNC6M/AOcSr0NnZDxq+q5tSf3EpAjuEtLXVcZXdhQoTlhHW603TyaXL+TC3daQIScU1I5zRNMNpeb6sDXcBJzMi3nSrFPcoxJGB/n9qbvLQlQcnmwkqLKpSUuiY000cqbTTIXyf+A1+9JhqXrVWjo1Z2ZRtAZXKZtRWPR4eEJ1V0RW3DA3quLFO7u3KzXZo8p1uwq4ivWGlYCIRwHSezEf/SSP1vOKnXPFgrvOJwrKwZk7RDff/az0YUSlNbqq50DV/RT0eejp+BtHzGjK7oAL9nJx1U1YkBVoNASpOC0VrdIUr3SsypAsW+mXbnxF+OiLHFZfnNN11QZCZWdaUHvO6HOEZp7S8KCN24zRMnfgrGfBu08pl/0ucuYH4="
services:
  - docker

env:
  REPO: poetapp/node
  DOCKER_COMPOSE_VERSION: 1.23.2

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - sudo chmod +x /usr/local/bin/docker-compose


install:
  - docker-compose -f docker-compose.yml -f docker-compose.travis.yml up -d
  - sleep 10

script:
  - docker-compose exec poet-node npm run lint
  - docker-compose exec poet-node npm run coverage


after:
  - docker images

before_deploy:
  - bash ./scripts/docker-build.sh

deploy:
  - provider: script
    skip_cleanup: true
    script:
      - bash ./scripts/docker-push.sh
    on:
      all_branches: true
  - provider: script
    skip_cleanup: true
    script:
      - docker-compose exec poet-node npx semantic-release --no-ci
    on:
      branch: master
